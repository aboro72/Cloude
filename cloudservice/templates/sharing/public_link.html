{% extends 'base.html' %}

{% block title %}{{ link.title|default:shared_object.name }} - CloudService{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            {% if is_expired %}
            <!-- Expired Link -->
            <div class="card border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="bi bi-exclamation-triangle me-2"></i> Link abgelaufen
                    </h5>
                </div>
                <div class="card-body text-center py-5">
                    <i class="bi bi-clock-history display-1 text-warning mb-4"></i>
                    <h4>Dieser Link ist nicht mehr gültig</h4>
                    <p class="text-muted">
                        Der Link ist abgelaufen oder die maximale Anzahl an Downloads wurde erreicht.
                    </p>
                    <a href="/" class="btn btn-primary mt-3">
                        <i class="bi bi-house"></i> Zur Startseite
                    </a>
                </div>
            </div>

            {% else %}
            <!-- Valid Link -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-share me-2"></i>
                        {{ link.title|default:"Geteilte Datei" }}
                    </h5>
                </div>
                <div class="card-body">
                    {% if link.description %}
                    <p class="text-muted mb-4">{{ link.description }}</p>
                    {% endif %}

                    <!-- File Info -->
                    <div class="card bg-light mb-4">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="me-4">
                                    <i class="bi bi-file-earmark display-4 text-primary"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <h5 class="mb-1">{{ shared_object.name }}</h5>
                                    <p class="text-muted mb-0">
                                        {% if shared_object.size >= 1048576 %}
                                            {{ shared_object.size|floatformat:2 }} MB
                                        {% elif shared_object.size >= 1024 %}
                                            {{ shared_object.size|floatformat:2 }} KB
                                        {% else %}
                                            {{ shared_object.size }} Bytes
                                        {% endif %}
                                        {% if shared_object.mime_type %}
                                        <span class="ms-2">{{ shared_object.mime_type }}</span>
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Preview for images -->
                    {% if shared_object.mime_type and 'image' in shared_object.mime_type %}
                    <div class="mb-4 text-center">
                        <img src="{{ shared_object.file.url }}" class="img-fluid rounded shadow-sm"
                             style="max-height: 500px;" alt="{{ shared_object.name }}"
                             onerror="this.style.display='none';">
                    </div>
                    {% endif %}

                    <!-- Preview for videos -->
                    {% if shared_object.mime_type and 'video' in shared_object.mime_type %}
                    <div class="mb-4 text-center">
                        <video controls class="w-100 rounded shadow-sm" style="max-height: 500px;">
                            <source src="{{ shared_object.file.url }}" type="{{ shared_object.mime_type }}">
                            Ihr Browser unterstützt dieses Videoformat nicht.
                        </video>
                    </div>
                    {% endif %}

                    <!-- Preview for audio -->
                    {% if shared_object.mime_type and 'audio' in shared_object.mime_type %}
                    <div class="mb-4 text-center py-4">
                        <i class="bi bi-music-note-beamed display-1 text-primary mb-3"></i>
                        <audio controls class="w-100" style="max-width: 400px;">
                            <source src="{{ shared_object.file.url }}" type="{{ shared_object.mime_type }}">
                            Ihr Browser unterstützt dieses Audioformat nicht.
                        </audio>
                    </div>
                    {% endif %}

                    <!-- Download Button -->
                    {% if link.allow_download %}
                    <div class="text-center">
                        <a href="{% url 'sharing:public_download' token=link.token %}"
                           class="btn btn-primary btn-lg">
                            <i class="bi bi-download me-2"></i> Herunterladen
                        </a>
                        <p class="text-muted mt-3 small">
                            <i class="bi bi-eye"></i> {{ link.view_count }} Aufrufe
                            <span class="mx-2">|</span>
                            <i class="bi bi-download"></i> {{ link.download_count }} Downloads
                        </p>
                    </div>
                    {% else %}
                    <div class="alert alert-info text-center">
                        <i class="bi bi-info-circle me-2"></i>
                        Download für diesen Link nicht aktiviert.
                    </div>
                    {% endif %}
                </div>
                <div class="card-footer text-muted text-center">
                    <small>
                        Geteilt von {{ link.owner.username }}
                        {% if link.expires_at %}
                        <span class="mx-2">|</span>
                        Gültig bis {{ link.expires_at|date:"d.m.Y" }}
                        {% endif %}
                    </small>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
